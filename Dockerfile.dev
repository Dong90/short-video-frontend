# syntax=docker/dockerfile:1
# 使用 BuildKit 以支持 cache mount，加速后续构建
FROM node:22.20-bullseye
ARG NEXT_PUBLIC_VERSION
ARG NEXT_PUBLIC_FRONTEND_URL=http://localhost:4007
ARG NEXT_PUBLIC_INTERNAL_FRONTEND_URL=http://localhost:5000
ENV NEXT_PUBLIC_VERSION=$NEXT_PUBLIC_VERSION
ENV NEXT_PUBLIC_FRONTEND_URL=$NEXT_PUBLIC_FRONTEND_URL
ENV NEXT_PUBLIC_INTERNAL_FRONTEND_URL=$NEXT_PUBLIC_INTERNAL_FRONTEND_URL
RUN apt-get update && apt-get install -y --no-install-recommends \
  g++ make python3 python3-pip bash nginx curl && \
  rm -rf /var/lib/apt/lists/*

RUN useradd -m -d /home/www -s /bin/bash www
RUN mkdir /www
RUN chown -R www:www /var/lib/nginx
RUN chown -R www:www /www


RUN npm --no-update-notifier --no-fund --global install pnpm@10.6.1 pm2

WORKDIR /app

# 1. 先只复制依赖清单 + Prisma schema，利用 Docker 层缓存
#    依赖未变时，此层不变，后续 pnpm install 可被缓存
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml .npmrc ./
COPY tsconfig.base.json tsconfig.json ./
COPY apps/backend/package.json apps/backend/
COPY apps/commands/package.json apps/commands/
COPY apps/extension/package.json apps/extension/
COPY apps/frontend/package.json apps/frontend/
COPY apps/orchestrator/package.json apps/orchestrator/
COPY apps/sdk/package.json apps/sdk/
COPY libraries/nestjs-libraries/src/database/prisma/schema.prisma libraries/nestjs-libraries/src/database/prisma/

# 2. pnpm install（依赖不变时整层命中缓存，节省 ~400s）
RUN --mount=type=cache,target=/root/.local/share/pnpm/store \
    pnpm install --frozen-lockfile

# 3. 复制源代码（不包含 node_modules，.dockerignore 已排除）
COPY . /app
COPY var/docker/nginx.conf /etc/nginx/nginx.conf
COPY var/docker/start.sh /start.sh
RUN chmod +x /start.sh
# 注意：
# - 为了减小单次内存峰值，这里改成“分步编译”：后端 → orchestrator → 前端，依次执行；
# - 你的 Docker 已经调到 12G，这里统一给每一步 Node old-space 开到 6G，避免 2G 左右就 OOM；
# - 因为是顺序执行（不是并行），整体内存压力会比一次性 `pnpm run build` 小很多。
# Next.js 构建缓存：后续构建复用 webpack 缓存
RUN --mount=type=cache,target=/app/apps/frontend/.next/cache \
    NODE_OPTIONS="--max-old-space-size=6144" pnpm run build:backend && \
    NODE_OPTIONS="--max-old-space-size=6144" pnpm run build:orchestrator && \
    NODE_OPTIONS="--max-old-space-size=6144" pnpm run build:frontend

CMD ["/start.sh"]
